<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMO Creator — Middle</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>IMO Creator — Middle</h1>
                <span id="middle-badge" class="badge todo">0%</span>
            </div>
        </header>

        <div class="mermaid-container compact">
            <pre class="mermaid" id="ladder-diagram">
flowchart TD
    classDef done fill:#22c55e,stroke:#15803d,color:#fff;
    classDef wip fill:#f59e0b,stroke:#b45309,color:#111;
    classDef todo fill:#ef4444,stroke:#7f1d1d,color:#fff;
            </pre>
        </div>

        <div class="controls-row">
            <div class="control-group">
                <label for="stage-selector">Stage:</label>
                <select id="stage-selector"></select>
            </div>
            
            <div class="control-group">
                <div class="editor-actions">
                    <button id="llm-draft" onclick="draftFromLLM()">Draft from LLM</button>
                    <button id="tighten" onclick="tightenFields()">Tighten</button>
                    <button id="save" class="primary" onclick="saveStage()">Save</button>
                    <button id="rescore" onclick="rescoreAndVisuals()">Re-score & Visuals</button>
                    <button id="simulate" onclick="runSimulator()" title="Test idempotency & joins">Simulate</button>
                </div>
            </div>
        </div>

        <div class="three-column-layout">
            <div class="column context-column">
                <h3>Context</h3>
                <div id="context-content">
                    <div class="context-section">
                        <strong>Mission:</strong>
                        <p id="mission-text"></p>
                    </div>
                    <div class="context-section">
                        <strong>Current Stage:</strong>
                        <p id="stage-info"></p>
                    </div>
                    <div class="context-section">
                        <strong>Universals:</strong>
                        <pre id="universals-text"></pre>
                    </div>
                </div>
            </div>

            <div class="column guidance-column">
                <h3>Guidance & Examples</h3>
                <div id="guidance-content">
                    <div id="stage-guidance"></div>
                    <div class="guidance-section">
                        <strong>What good looks like:</strong>
                        <ul id="good-examples"></ul>
                    </div>
                    <div class="guidance-section" id="heir-info" style="display:none;">
                        <strong>HEIR Integration:</strong>
                        <p>HEIR-capable gates allow runtime validation with rulesets. Use <code>heir_ruleset_id</code> like "heir://imo@>=1.0.0" for versioned rules.</p>
                    </div>
                </div>
            </div>

            <div class="column editor-column">
                <h3>Editor</h3>
                <div class="editor-header">
                    <span id="editor-label">Stage Fields (JSON)</span>
                </div>
                <textarea id="json-editor" class="json-editor"></textarea>
                <div id="save-feedback" class="feedback-message"></div>
            </div>
        </div>

        <div class="navigation">
            <a href="input.html">← Input Page</a>
            <a href="overview.html">Overview</a>
            <a href="output.html">Output Page →</a>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof renderMiddlePage === 'function') {
                renderMiddlePage();
            }
        });
    </script>
</body>
</html>